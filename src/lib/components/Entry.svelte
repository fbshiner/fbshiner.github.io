<script>
    import { onMount } from "svelte";

    // the way to go about this is, in your given display grid, you get the import 
    let { PageContext } = $props();
    // console.log(PageContext);

    // const imageRightAlign = Math.random() > 0.5;
    const imageAlign = Math.random() > 0.5;
    function r(start, end) {
        return (Math.random() * (end - start)) + start;
    }
    const h = r(0, 360);
    const c = h + 180 % 360;
    const s = r(35, 100);
    const v = r(50, 75);

    const mainColor = `hsl(${h}deg ${s}% ${v}%);`;
    const complementaryColor = `hsl(${c}deg ${s}% ${v}%);`;
    
    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');   // convert to Hex and prefix "0" if needed
        };
        return `#${f(0)}${f(8)}${f(4)}`;
    }

    onMount(() => {
        const categoryDir = window.location.pathname.split("\/")[1];
        let svg;
        switch (categoryDir) {
            case "knitting":
                svg = `<svg fill="${hslToHex(c,s,v)}" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve">
                <path d="M457.596,359.689c30.698-38.077,49.138-86.397,49.138-138.822c0-75.203-37.93-141.968-95.594-182.141 c-0.488-0.49-1.044-0.94-1.686-1.326c-0.316-0.189-0.637-0.354-0.96-0.506c-27.191-18.368-58.625-30.866-92.448-35.677 c-0.526-0.121-1.053-0.195-1.576-0.222C304.779-0.312,294.9-1,284.867-1C222.096-1,165.2,25.422,124.741,67.689 c-1.138,0.702-2.049,1.675-2.685,2.868C85.45,110.16,63,163.015,63,220.867c0,48.593,15.845,93.658,42.606,130.311 C104.44,373.959,86.117,391.533,63,391.533c-33.28,0-59.733,26.453-59.733,59.733C3.267,484.547,29.72,511,63,511 c33.28,0,59.733-26.453,59.733-59.733c0-5.12-3.413-8.533-8.533-8.533c-5.12,0-8.533,3.413-8.533,8.533 c0,23.893-18.773,42.667-42.667,42.667c-23.893,0-42.667-18.773-42.667-42.667c0-23.893,18.773-42.667,42.667-42.667 c26.424,0,48.528-16.684,56.521-40.213c40.707,45.55,99.823,74.347,165.346,74.347c67.598,0,128.376-30.649,169.156-78.724 C455.717,363.084,456.956,361.594,457.596,359.689z M83.049,255.611c-1.952-11.301-2.982-22.908-2.982-34.744 c0-10.689,0.834-21.193,2.433-31.452c5.53,8.065,13.535,16.109,24.021,23.772c49.493,36.693,139.093,64.853,239.787,64.853 c45.436,0,93.267-5.621,139.63-18.366c-6.389,32.962-20.743,63.169-40.969,88.518C243.649,356.078,131.549,327.149,83.049,255.611 z M488.601,241.757c-0.79,0.001-1.583,0.137-2.348,0.443c-93.867,26.453-271.36,31.573-369.493-42.667 c-17.067-12.8-26.453-26.453-26.453-36.693c0-1.346-0.242-2.571-0.683-3.65c7.695-24.184,19.784-46.453,35.316-65.866 c5.165,12.359,15.292,24.611,29.443,35.812c0.761,0.959,1.749,1.708,2.915,2.219c21.703,16.054,51.815,29.681,88.295,38.531 c1.382,0.953,3.126,1.487,5.14,1.487c0.398,0,0.791-0.012,1.187-0.016c26.78,5.971,56.786,9.403,89.266,9.403 c42.667,0,90.453-5.973,139.093-20.48c0.057-0.011,0.111-0.032,0.168-0.045c5.988,19.18,9.219,39.547,9.219,60.632 C489.667,227.916,489.305,234.886,488.601,241.757z M392.834,47.064c-35.474,53.412-79.032,106.094-140.116,107.215 c-25.804-5.976-48.24-14.458-66.459-24.542c58.609-11.296,99.689-61.111,132.352-110.854 C345.448,23.38,370.556,33.141,392.834,47.064z M474.766,144.415c-64.627,18.298-124.87,22.442-176.196,17.329 c44.981-18.671,79.545-61.773,108.499-104.949C436.938,79.132,460.562,109.408,474.766,144.415z M284.867,16.067 c4.88,0,9.719,0.184,14.516,0.525c-45.479,67.226-86.486,97.293-135.364,98.425c-15.163-12.053-24.315-24.708-25.727-36.809 C175.558,39.934,227.556,16.067,284.867,16.067z M93.727,294.187c53.719,49.429,146.984,72.599,292.686,72.599 c14.058,0,28.129-0.405,42.738-0.933c-37.091,36.915-88.142,59.813-144.285,59.813 C198.031,425.667,123.379,370.889,93.727,294.187z">
                </path></svg>`
                break;
            case "music":
                svg = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10.0909 11.9629L19.3636 8.63087V14.1707C18.8126 13.8538 18.1574 13.67 17.4545 13.67C15.4964 13.67 13.9091 15.096 13.9091 16.855C13.9091 18.614 15.4964 20.04 17.4545 20.04C19.4126 20.04 21 18.614 21 16.855C21 16.855 21 16.8551 21 16.855L21 7.49236C21 6.37238 21 5.4331 20.9123 4.68472C20.8999 4.57895 20.8852 4.4738 20.869 4.37569C20.7845 3.86441 20.6352 3.38745 20.347 2.98917C20.2028 2.79002 20.024 2.61055 19.8012 2.45628C19.7594 2.42736 19.716 2.39932 19.6711 2.3722L19.6621 2.36679C18.8906 1.90553 18.0233 1.93852 17.1298 2.14305C16.2657 2.34086 15.1944 2.74368 13.8808 3.23763L11.5963 4.09656C10.9806 4.32806 10.4589 4.52419 10.0494 4.72734C9.61376 4.94348 9.23849 5.1984 8.95707 5.57828C8.67564 5.95817 8.55876 6.36756 8.50501 6.81203C8.4545 7.22978 8.45452 7.7378 8.45455 8.33743V16.1307C7.90347 15.8138 7.24835 15.63 6.54545 15.63C4.58735 15.63 3 17.056 3 18.815C3 20.574 4.58735 22 6.54545 22C8.50355 22 10.0909 20.574 10.0909 18.815C10.0909 18.815 10.0909 18.8151 10.0909 18.815L10.0909 11.9629Z" fill="${hslToHex(c,s,v)}">
                </path></svg>`;
                break;
            case "spinning":
                svg = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 10V3M13.4141 10.5857L18.3639 5.63599M14 12H21M13.4143 13.4141L18.364 18.3639M12 14V21M10.5859 13.4143L5.63611 18.364M10 12H3M10.5857 10.5859L5.63599 5.63611M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12ZM14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12Z" stroke="${hslToHex(c,s,v)}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                </path></svg>`;
                break;
            case "misc":
                svg = `<svg fill="${hslToHex(c,s,v)}" height="200px" width="200px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g> <path d="M232.389,171.905c-5.603-5.603-13.051-8.688-20.974-8.688c-7.923,0-15.372,3.085-20.973,8.688 c-5.604,5.603-8.689,13.052-8.689,20.975c0,7.923,3.085,15.373,8.688,20.974c5.603,5.603,13.051,8.688,20.974,8.688 c7.923,0,15.372-3.085,20.975-8.688C243.955,202.288,243.955,183.471,232.389,171.905z M221.172,202.636 c-2.606,2.605-6.071,4.04-9.757,4.04c-3.686,0-7.15-1.434-9.756-4.04s-4.04-6.071-4.04-9.756s1.434-7.15,4.04-9.756h0.001 c2.605-2.606,6.07-4.04,9.755-4.04s7.151,1.435,9.756,4.04C226.55,188.503,226.55,197.257,221.172,202.636z"></path> </g> </g> <g> <g> <path d="M342.739,61.555c-11.564-11.566-30.384-11.566-41.949,0h-0.001c-11.565,11.566-11.565,30.384,0.001,41.95 c5.782,5.784,13.378,8.674,20.974,8.674s15.192-2.891,20.974-8.674c5.604-5.602,8.689-13.051,8.689-20.974 C351.428,74.606,348.342,67.156,342.739,61.555z M331.521,92.286c-5.381,5.378-14.134,5.38-19.513,0 c-5.38-5.38-5.38-14.133,0-19.513c5.381-5.378,14.132-5.378,19.513,0c2.606,2.606,4.04,6.071,4.04,9.756 S334.127,89.68,331.521,92.286z"></path> </g> </g> <g> <g> <path d="M342.739,282.255c-11.564-11.566-30.384-11.566-41.949,0h-0.001c-11.565,11.565-11.565,30.384,0.001,41.95 c5.782,5.784,13.378,8.674,20.974,8.674s15.192-2.891,20.975-8.674c5.603-5.603,8.688-13.052,8.688-20.975 C351.428,295.306,348.342,287.856,342.739,282.255z M331.521,312.986c-5.381,5.378-14.132,5.377-19.513,0 c-5.38-5.38-5.38-14.133,0-19.513c5.381-5.378,14.132-5.378,19.513,0c2.606,2.606,4.04,6.071,4.04,9.756 S334.126,310.38,331.521,312.986z"></path> </g> </g> <g> <g> <path d="M453.089,171.905c-5.603-5.603-13.051-8.688-20.974-8.688c-7.923,0-15.372,3.085-20.973,8.688 c-5.604,5.603-8.689,13.052-8.689,20.975c0,7.923,3.085,15.373,8.688,20.974c5.603,5.603,13.051,8.688,20.974,8.688 c7.923,0,15.372-3.085,20.976-8.688C464.655,202.288,464.655,183.471,453.089,171.905z M441.872,202.636 c-2.606,2.605-6.071,4.04-9.757,4.04s-7.15-1.434-9.756-4.04c-2.606-2.606-4.04-6.071-4.04-9.756s1.434-7.15,4.04-9.756h0.001 c2.605-2.606,6.07-4.04,9.755-4.04c3.685,0,7.151,1.435,9.756,4.04C447.25,188.503,447.25,197.257,441.872,202.636z"></path> </g> </g> <g> <g> <path d="M144.069,335.625c-16.356,0-29.662,13.307-29.662,29.662s13.306,29.662,29.662,29.662s29.664-13.306,29.664-29.662 C173.732,348.932,160.425,335.625,144.069,335.625z M144.069,379.084c-7.607,0-13.797-6.189-13.797-13.797 c0-7.607,6.19-13.797,13.797-13.797c7.608,0,13.798,6.19,13.798,13.797S151.677,379.084,144.069,379.084z"></path> </g> </g> <g> <g> <path d="M66.04,257.595c-16.356,0-29.664,13.306-29.664,29.662c0,16.355,13.307,29.662,29.664,29.662 c16.355,0,29.661-13.306,29.662-29.662C95.703,270.902,82.397,257.595,66.04,257.595z M66.04,301.054 c-7.608,0-13.798-6.19-13.798-13.797c0-7.607,6.19-13.797,13.798-13.797c7.607,0,13.796,6.19,13.797,13.797 C79.837,294.865,73.647,301.054,66.04,301.054z"></path> </g> </g> <g> <g> <path d="M222.097,257.595c-16.356,0-29.662,13.306-29.662,29.662c0,16.355,13.306,29.662,29.662,29.662 s29.664-13.306,29.664-29.662C251.761,270.902,238.454,257.595,222.097,257.595z M222.097,301.054 c-7.607,0-13.797-6.19-13.797-13.797c0-7.607,6.19-13.797,13.797-13.797c7.609,0,13.798,6.19,13.798,13.797 C235.895,294.865,229.705,301.054,222.097,301.054z"></path> </g> </g> <g> <g> <path d="M66.04,413.654c-16.356,0-29.664,13.307-29.664,29.662c0,16.355,13.307,29.662,29.664,29.662 c16.355,0,29.662-13.307,29.662-29.662C95.703,426.961,82.397,413.654,66.04,413.654z M66.04,457.112 c-7.608,0-13.798-6.19-13.798-13.797c0-7.607,6.19-13.797,13.798-13.797c7.607,0,13.797,6.19,13.797,13.797 C79.837,450.922,73.647,457.112,66.04,457.112z"></path> </g> </g> <g> <g> <path d="M222.097,413.654c-16.356,0-29.662,13.307-29.662,29.662c0,16.355,13.306,29.662,29.662,29.662 s29.664-13.307,29.664-29.662C251.761,426.961,238.454,413.654,222.097,413.654z M222.097,457.112 c-7.607,0-13.797-6.19-13.797-13.797c0-7.607,6.19-13.797,13.797-13.797c7.609,0,13.798,6.19,13.798,13.797 C235.895,450.922,229.705,457.112,222.097,457.112z"></path> </g> </g> <g> <g> <path d="M502.449,169.82L344.824,12.196c-6.159-6.16-14.35-9.552-23.06-9.552c-8.711,0-16.901,3.392-23.06,9.551L141.081,169.82 c-6.16,6.159-9.552,14.349-9.552,23.06c0.001,8.711,3.393,16.901,9.552,23.06l5.277,5.277H32.612 C14.63,221.217,0,235.847,0,253.83v222.914c0,17.982,14.63,32.612,32.612,32.612h222.914c17.982,0,32.611-14.63,32.611-32.612 V362.997l10.567,10.567c6.158,6.159,14.348,9.551,23.059,9.552c0.001,0,0.002,0,0.003,0c8.709,0,16.899-3.392,23.059-9.552 L502.448,215.94c6.16-6.159,9.552-14.349,9.552-23.06S508.608,175.98,502.449,169.82z M272.272,476.743L272.272,476.743 c0,9.234-7.513,16.747-16.746,16.747H32.612c-9.234,0-16.747-7.513-16.747-16.747V253.83c0-9.234,7.513-16.747,16.747-16.747 h222.914c9.233,0,16.746,7.513,16.746,16.747V476.743z M491.23,204.722L333.606,362.345c-3.164,3.164-7.368,4.905-11.84,4.905 h-0.001c-4.474,0-8.68-1.742-11.841-4.905l-21.786-21.785V253.83c0-16.859-12.859-30.771-29.283-32.444 c-1.095-0.111-2.205-0.168-3.33-0.168h-86.731l-16.496-16.496c-3.163-3.164-4.906-7.369-4.906-11.842s1.741-8.679,4.906-11.841 L309.924,23.415c3.161-3.163,7.367-4.905,11.84-4.905c4.473,0,8.678,1.742,11.841,4.905l157.623,157.623 c3.164,3.164,4.906,7.369,4.906,11.842S494.393,201.559,491.23,204.722z"></path> </g> </g> </g></svg>`;
                break;
        }
        const encodedSvg = encodeURIComponent(svg);
        const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodedSvg}`; 
        
        const canvas = document.getElementById("svg-canvas");
        const ctx = canvas.getContext("2d");

        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;

        function clear() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        const FPS = 30;

        const NUM_ROWS = 5;
        const NUM_COLS = 5;
        const PLACEMENT_RANGE = 5;
        const WIDTH_SPACING = (WIDTH)/NUM_ROWS;
        const HEIGHT_SPACING = (HEIGHT)/NUM_COLS;

        // const shapes = [];
        const JITTER_RANGE = 2;
        const shape = {
            "x": 0,
            "y": 0,
            "length": 75,
        }
        const center = shape.length/2; 

        let i = 0;
        const THETA = 1; // 1 degree of rotation per frame
        ctx.translate(25, 25);
        function frame() {
            clear();

            // const xJitter = Math.random() * JITTER_RANGE - (JITTER_RANGE/2);
            // const yJitter = Math.random() * JITTER_RANGE - (JITTER_RANGE/2);
            ctx.drawImage(img, shape.x, shape.y, shape.length, shape.length);
            ctx.translate(center, center);
            ctx.rotate((4*Math.PI)/180);
            ctx.translate(-center, -center);
            // ctx.setTransform(1, 0, 0,  1, 0, 0);
            i = (i + THETA) % 360;

            setTimeout(frame, 1000/FPS);
        }

        const img = new Image();

        img.onload = () => {
            setTimeout(frame, 1000/FPS);
        };

        img.onerror = (error) => {
            console.error("Failed to load svg: ", error);
        };

        img.src = svgDataUrl;
    });

</script>

<style>
    h1 {
        text-align: center;
    }

    .svg-canvas-left {
        justify-self: flex-start;
    }

    .svg-canvas-right {
        justify-self: flex-end;
    }

    /* ========================================================================================================== */
    @media only screen and (max-width: 500px) {
        h1 {
            padding-bottom: 2%;
        }
        
        .image-and-description {
            width: 100%;

            display: grid;
            grid-template-columns: auto;
            grid-template-rows: 1fr 1fr;
            align-items: center;
            text-align: center;
        }

        img {
            max-width: 100%;
            height: auto;
        }
    }

    @media only screen and (min-width: 500px) {
        .image-and-description {
            width: 100%;

            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto;
            align-items: center;
            text-align: center;
        }

        .entry-imageLeftAlign {
            order: 0;
        }

        .entry-imageRightAlign {
            order: 1;
        }   

        .entry-textLeftAlign {
            order: 0;
        }

        .entry-textRightAlign {
            order: 1;
        }

        /* img {
            max-width: 100%;
            height: auto;
        } */
    }

    .fullscreen-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
    }

    .entry-page {
        width: 90%;
        height: 100%;
        margin: 0 auto;

        display: grid;
        grid-template-rows: 1fr 5fr 1fr 3fr;
        grid-template-columns: auto;
    }

    .entry-header {
        width: 100%;
        text-align: center;
    }

    .link-and-player {
        width: 100%;

        display: grid;
        grid-template-rows: 1fr 1fr;
        grid-template-columns: auto;
        text-align: center;
        align-items: flex-start;
    }

    audio {
        filter: sepia(20%) saturate(70%) grayscale(1) contrast(99%) invert(12%);
    }
</style>

<div class="fullscreen-container" style={`background-color:${mainColor}`}>
    <div class="entry-page">
        <div class="entry-header">
            <h1>{PageContext.title}</h1>
        </div>

        <div class="image-and-description">
            <div class={["entry-image", (imageAlign? "entry-imageRightAlign": "entry-imageLeftAlign")]}>
                <img src={PageContext.image} style={`border: solid ${r(3, 10)}px ${complementaryColor};`} alt={PageContext.alt?PageContext.alt:"Invalid Alt Text"}/>
            </div>
            
            <div class={["entry-description", (imageAlign? "entry-textLeftAlign": "entry-textRightAlign")]}>
                {#if PageContext.description && PageContext.description !== "test"}
                    {PageContext.description}
                {/if}
            </div>
        </div>

        <div class="link-and-player">
            <div class="entry-link">
                {#if PageContext.link}
                    <a href={PageContext.link}>
                        {#if PageContext.linkText}
                            {PageContext.linkText}
                        {:else}
                            Link
                        {/if}

                    </a>
                {/if}
            </div>
            <div class="entry-player">
                {#if PageContext.musicFile}
                    <audio controls>
                        <source src={PageContext.musicFile}>
                    </audio>
                {/if}
            </div>
        </div>
        <canvas id="svg-canvas" class={imageAlign? "svg-canvas-left": "svg-canvas-right"}>

        </canvas>
    </div>


</div>